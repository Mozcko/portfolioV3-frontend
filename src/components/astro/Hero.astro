---
import { styles } from "../../styles";
import { logo } from "../../assets";
// Importamos el componente React para la parte 3D
import ComputersCanvas from "../react/canvas/Computers.jsx";
import Typewriter from "../react/hero/Typewriter.jsx";

interface Props {
  t: Record<string, any>;
}

interface Social {
  name: string;
  link: string;
  image_route?: string;
  file?: string;
  icon?: string;
  image?: string;
}

const { t = {} } = Astro.props;

// --- SERVER SIDE DATA FETCHING ---
// Esto ocurre en tiempo de construcción o en el servidor, no en el navegador del usuario.
const socials: Social[] = [];
const API_URL = (import.meta.env.PUBLIC_API_URL || '').replace(/\/$/, '');

// Preparamos los skills para pasarlos al script del cliente
const skills: string[] = Array.isArray(t["hero.skills"]) ? t["hero.skills"] : ["Full Stack Developer", "Linux Enthusiast"];
---

<section class="relative w-full h-[93vh] mx-auto flex flex-col lg:flex-row overflow-hidden bg-primary bg-hero-pattern bg-cover bg-no-repeat bg-center">
  
  <!-- Lado Izquierdo: HTML Estático (Carga instantánea) -->
  <div class={`flex-1 lg:flex-[1.5] relative ${styles.paddingX} flex flex-col justify-center h-full z-10 pt-32`}>
    
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center gap-6 mb-2">
      <img src={typeof logo === 'string' ? logo : logo.src} alt="Mozcko Logo" class="w-28 h-28 sm:w-32 sm:h-32 object-cover rounded-full border-4 border-white/10 shadow-card" />
      <h1 class={`${styles.heroHeadText} text-white text-center sm:text-left`}>
        {t["hero.welcome"] || "Hi!, my name is"} <span class='text-[#915eff]'>Mozcko</span>
      </h1>
    </div>

    <!-- Subtítulo y Typewriter -->
    <div class="flex flex-col items-center sm:items-start">
        <div class="mt-2 flex flex-row flex-wrap justify-center sm:justify-start items-baseline gap-2">
          <p class={`${styles.heroSubText} text-white-100 text-[20px] whitespace-nowrap`}>
            {t["hero.i_am"] || "and I am a:"}
          </p>
          <p class={`${styles.heroSubText} text-[#915eff] font-mono`}>
            <Typewriter 
              client:load 
              words={skills} 
              textClass="" 
              cursorClass="ml-1" 
            />
          </p>
        </div>

        <!-- Redes Sociales (Renderizadas en servidor) -->
        <!-- Contenedor para carga del cliente (mejora velocidad de navegación) -->
        <div id="hero-socials-container" class="mt-5 flex gap-4 min-h-[40px]">
          <div class="w-10 h-10 rounded-full bg-white/10 animate-pulse border border-white/5"></div>
          <div class="w-10 h-10 rounded-full bg-white/10 animate-pulse border border-white/5"></div>
          <div class="w-10 h-10 rounded-full bg-white/10 animate-pulse border border-white/5"></div>
        </div>
    </div>
  </div>

  <!-- Lado Derecho: Componente React (Isla Interactiva) -->
  <div class="flex-1 w-full h-[40vh] lg:h-full relative" transition:persist>
    <!-- client:visible asegura que solo cargue el JS de Three.js cuando el usuario lo vea -->
    <ComputersCanvas client:visible />
  </div>
</section>

<script define:vars={{ API_URL }}>
  document.addEventListener('astro:page-load', async () => {
    const container = document.getElementById('hero-socials-container');
    if (!container) return;

    const getImageUrl = (path) => {
      if (!path) return '';
      if (path.startsWith('http') || path.startsWith('data:')) return path;
      try {
        const urlObj = new URL(API_URL);
        return `${urlObj.origin}${path}`;
      } catch(e) { return path; }
    };

    const renderSocials = (socials) => {
      container.innerHTML = socials.map((social, index) => `
        <a href="${social.link}" target="_blank" rel="noopener noreferrer" 
           style="animation-delay: ${index * 100}ms"
           class="social-icon-anim opacity-0 w-10 h-10 flex justify-center items-center rounded-full bg-white/5 hover:bg-white/20 transition-colors border border-white/10">
          <img src="${getImageUrl(social.image_route || social.image || social.icon)}" 
               alt="${social.name}" 
               class="w-3/5 h-3/5 object-contain" />
        </a>
      `).join('');
    };

    // Optimización: Usar caché de sesión para evitar fetch en cada navegación
    const cached = sessionStorage.getItem('hero_socials_cache');
    if (cached) {
      renderSocials(JSON.parse(cached));
      return;
    }

    try {
      const response = await fetch(`${API_URL}/socials/`);
      if (response.ok) {
        const socials = await response.json();
        renderSocials(socials);
        sessionStorage.setItem('hero_socials_cache', JSON.stringify(socials));
      }
    } catch (error) {
      console.error("Error fetching socials client-side:", error);
    }
  });
</script>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  :global(.social-icon-anim) {
    animation: fadeInUp 0.5s ease-out forwards;
  }
</style>