---
import { styles } from "../../styles";
import { logo } from "../../assets";
// Importamos el componente React para la parte 3D
import ComputersCanvas from "../react/canvas/Computers.jsx";
import Typewriter from "../react/hero/Typewriter.jsx";
// Importamos componente optimizado de imágenes (Opcional, ver punto 2)
import { Image } from 'astro:assets';

interface Props {
  t: Record<string, any>;
}

interface Social {
  name: string;
  link: string;
  image_route?: string;
  file?: string;
  icon?: string;
  image?: string;
}

const { t = {} } = Astro.props;

// --- SERVER SIDE DATA FETCHING (OPTIMIZADO) ---
// Hacemos el fetch AQUÍ, en el servidor, antes de enviar el HTML
const API_URL = (import.meta.env.PUBLIC_API_URL || '').replace(/\/$/, '');
let socials: Social[] = [];

try {
  // Usamos un timeout para que si el backend tarda, no bloquee toda la página
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 seg max

  const response = await fetch(`${API_URL}/socials/`, { signal: controller.signal });
  if (response.ok) {
    socials = await response.json();
  }
  clearTimeout(timeoutId);
} catch (error) {
  console.error("Error fetching socials server-side:", error);
  // Si falla, socials se queda vacío y no rompe la página
}

// Helper para URLs de imágenes
const getImageUrl = (path: string | undefined) => {
  if (!path) return '';
  if (path.startsWith('http') || path.startsWith('data:')) return path;
  return `${API_URL}${path}`;
};

const skills: string[] = Array.isArray(t["hero.skills"]) ?
  t["hero.skills"] : ["Full Stack Developer", "Linux Enthusiast"];
---

<section class="relative w-full h-[93vh] mx-auto flex flex-col lg:flex-row overflow-hidden">

  <div class={`flex-1 lg:flex-[1.5] relative ${styles.paddingX} flex flex-col justify-center h-full z-10 pt-32`}>
    
    <div class="flex flex-col sm:flex-row items-center gap-6 mb-2">
      <img src={typeof logo === 'string' ? logo : logo.src} alt="Mozcko Logo" class="w-28 h-28 sm:w-32 sm:h-32 object-cover rounded-full border-4 border-white/10 shadow-card" />
      <h1 class={`${styles.heroHeadText} text-white text-center sm:text-left`}>
        {t["hero.welcome"] || "Hi!, my name is"} <span class='text-[#915eff]'>Mozcko</span>
      </h1>
    </div>

    <div class="flex flex-col items-center sm:items-start">
        <div class="mt-2 flex flex-row flex-wrap justify-center sm:justify-start items-baseline gap-2">
          <p class={`${styles.heroSubText} text-white-100 text-[20px] whitespace-nowrap`}>
            {t["hero.i_am"] || "and I am a:"}
          </p>
          <p class={`${styles.heroSubText} text-[#915eff] font-mono`}>
            <Typewriter client:visible words={skills} textClass="" cursorClass="ml-1" />
          </p>
        </div>

        <div class="mt-5 flex gap-4 min-h-[40px]">
          {socials.map((social, index) => (
            <a 
              href={social.link} 
              target="_blank" 
              rel="noopener noreferrer" 
              class="social-icon-anim w-10 h-10 flex justify-center items-center rounded-full bg-white/5 hover:bg-white/20 transition-colors border border-white/10"
              style={`animation-delay: ${index * 100}ms`}
            >
              <img 
                src={getImageUrl(social.image_route || social.image || social.icon)} 
                alt={social.name} 
                class="w-3/5 h-3/5 object-contain" 
                loading="lazy" 
                width="24" 
                height="24"
              />
            </a>
          ))}
        </div>
    </div>
  </div>

  <div class="flex-1 w-full h-[40vh] lg:h-full relative z-10" transition:persist>
    <ComputersCanvas client:visible />
  </div>
</section>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .social-icon-anim {
    opacity: 0; /* Empieza invisible para la animación */
    animation: fadeInUp 0.5s ease-out forwards;
  }
</style>