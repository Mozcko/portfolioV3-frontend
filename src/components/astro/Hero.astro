---
import { styles } from "../../styles";
import { logo } from "../../assets";
// Importamos el componente React para la parte 3D
import ComputersCanvas from "../react/canvas/Computers.jsx";

interface Props {
  t: Record<string, any>;
}

interface Social {
  name: string;
  link: string;
  image_route?: string;
  file?: string;
  icon?: string;
  image?: string;
}

const { t = {} } = Astro.props;

// --- SERVER SIDE DATA FETCHING ---
// Esto ocurre en tiempo de construcción o en el servidor, no en el navegador del usuario.
let socials: Social[] = [];
try {
  const API_URL = (import.meta.env.PUBLIC_API_URL || '').replace(/\/$/, '');
  const response = await fetch(`${API_URL}/socials/`);
  if (response.ok) {
    socials = await response.json();
  }
} catch (error) {
  console.error("Error fetching socials in Hero:", error);
}

// Helper para imágenes
const getImageUrl = (path: string | undefined) => {
    if (!path) return null;
    if (path.startsWith('http') || path.startsWith('data:')) return path;
    const API_URL = (import.meta.env.PUBLIC_API_URL || '').replace(/\/$/, '');
    try {
        const urlObj = new URL(API_URL);
        return `${urlObj.origin}${path}`;
    } catch(e) { return path; }
};

// Preparamos los skills para pasarlos al script del cliente
const skills = Array.isArray(t["hero.skills"]) ? t["hero.skills"] : ["Full Stack Developer", "Linux Enthusiast"];
---

<section class="relative w-full h-screen mx-auto flex flex-col lg:flex-row overflow-hidden">
  
  <!-- Lado Izquierdo: HTML Estático (Carga instantánea) -->
  <div class={`flex-1 lg:flex-[1.5] relative ${styles.paddingX} flex flex-col justify-center h-full z-10 pt-20 sm:pt-0`}>
    
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center gap-6 mb-2">
      <img src={typeof logo === 'string' ? logo : logo.src} alt="Mozcko Logo" class="w-28 h-28 sm:w-32 sm:h-32 object-cover rounded-full border-4 border-white/10 shadow-card" />
      <h1 class={`${styles.heroHeadText} text-white text-center sm:text-left`}>
        {t["hero.welcome"] || "Hi!, my name is"} <span class='text-[#915eff]'>Mozcko</span>
      </h1>
    </div>

    <!-- Subtítulo y Typewriter -->
    <div class="flex flex-col items-center sm:items-start">
        <div class="mt-2 flex flex-row flex-wrap justify-center sm:justify-start items-baseline gap-2">
          <p class={`${styles.heroSubText} text-white-100 text-[20px] whitespace-nowrap`}>
            {t["hero.i_am"] || "and I am a:"}
          </p>
          <p class={`${styles.heroSubText} text-[#915eff] font-mono`}>
              <span id="typewriter-text"></span>
              <span id="cursor" class="opacity-100 ml-1">_</span>
          </p>
        </div>

        <!-- Redes Sociales (Renderizadas en servidor) -->
        <div class="mt-8 flex flex-wrap justify-center sm:justify-start gap-4">
          {socials.map((social) => (
            <a
              href={social.link}
              target="_blank"
              rel="noopener noreferrer"
              title={social.name}
              class="bg-tertiary border border-white/10 hover:bg-white/10 p-3 rounded-full transition-colors flex items-center justify-center"
            >
              {(social.image_route || social.file || social.icon || social.image) && (
                <img src={getImageUrl(social.image_route || social.file || social.icon || social.image)} alt={social.name} class="w-6 h-6 object-contain" />
              )}
            </a>
          ))}
        </div>
    </div>
  </div>

  <!-- Lado Derecho: Componente React (Isla Interactiva) -->
  <div class="flex-1 w-full h-[40vh] lg:h-full relative">
    <!-- client:visible asegura que solo cargue el JS de Three.js cuando el usuario lo vea -->
    <ComputersCanvas client:visible />
  </div>
</section>

<!-- Script ligero para el efecto de escritura -->
<script define:vars={{ skills }}>
  const textElement = document.getElementById('typewriter-text');
  const cursorElement = document.getElementById('cursor');
  
  let skillIndex = 0;
  let charIndex = 0;
  let isDeleting = false;
  let typeSpeed = 100;

  function type() {
    if (!textElement) return;

    const currentSkill = skills[skillIndex];
    
    if (isDeleting) {
      textElement.textContent = currentSkill.substring(0, charIndex - 1);
      charIndex--;
      typeSpeed = 50;
    } else {
      textElement.textContent = currentSkill.substring(0, charIndex + 1);
      charIndex++;
      typeSpeed = 100;
    }

    if (!isDeleting && charIndex === currentSkill.length) {
      isDeleting = true;
      typeSpeed = 1500; // Pausa al terminar de escribir
    } else if (isDeleting && charIndex === 0) {
      isDeleting = false;
      skillIndex = (skillIndex + 1) % skills.length;
      typeSpeed = 500; // Pausa antes de empezar nueva palabra
    }

    setTimeout(type, typeSpeed);
  }

  // Efecto parpadeo cursor
  setInterval(() => {
    if(cursorElement) cursorElement.classList.toggle('opacity-0');
  }, 500);

  // Iniciar
  if (skills.length > 0 && textElement) {
    setTimeout(type, 1000);
  }
</script>